import{s as _,D as x}from"./supabase-BMp_lEby-v2.js";const u=document.getElementById("paymentForm"),l=document.getElementById("email"),o=document.getElementById("cardNumber"),i=document.getElementById("expiryDate"),d=document.getElementById("cvv"),M=document.getElementById("terms"),h=document.getElementById("payButton"),E=document.getElementById("paymentLoading"),I=2900,L="usd";let m=null;function Y(){console.log("Payment page initialized"),T(),D(),$()}function T(){try{const e=sessionStorage.getItem("upgradeAnalysis")||sessionStorage.getItem("currentAnalysis");e?(m=JSON.parse(e),console.log("Loaded analysis data for payment:",m)):(console.warn("No analysis data found for payment"),y("No analysis data found. Please upload a resume first."))}catch(e){console.error("Error loading analysis data:",e)}}function D(){u&&u.addEventListener("submit",C),o&&o.addEventListener("input",B),i&&i.addEventListener("input",V),d&&d.addEventListener("input",p)}function $(){[l,o,i,d].forEach(t=>{t&&(t.addEventListener("blur",O),t.addEventListener("input",f))})}async function C(e){if(e.preventDefault(),console.log("Processing payment..."),!!R()){P(!0);try{const t=await S();await F(t),await k(),window.location.href="./success.html"}catch(t){console.error("Payment failed:",t),y("Payment failed. Please try again.")}finally{P(!1)}}}function R(){let e=!0;return b(l.value)||(c(l,"Please enter a valid email address"),e=!1),w(o.value)||(c(o,"Please enter a valid card number"),e=!1),N(i.value)||(c(i,"Please enter a valid expiry date (MM/YY)"),e=!1),p(d.value)||(c(d,"Please enter a valid CVV"),e=!1),M.checked||(y("Please accept the terms and conditions"),e=!1),e}async function S(){return console.log("Processing payment with Stripe..."),await new Promise(e=>setTimeout(e,2e3)),{id:`pi_${Date.now()}`,amount:I,currency:L,status:"succeeded",method:"card",email:l.value}}async function F(e){var t;try{const n=((t=(await _.auth.getUser()).data.user)==null?void 0:t.id)||"anonymous";await x.savePaymentRecord(n,{amount:e.amount,status:e.status,method:e.method,payment_id:e.id}),console.log("Payment record saved")}catch(a){console.error("Failed to save payment record:",a)}}async function k(){try{console.log("Triggering resume improvement with Gemini AI...");const e="https://bestcvbuilder-api.onrender.com";console.log(`ğŸš€ PAYMENT: Calling resume-fix API at ${e}/api/resume-fix`),console.log(`ğŸ“§ PAYMENT: User email: ${l.value}`),console.log(`ğŸ“‹ PAYMENT: Analysis data keys: ${Object.keys(m)}`);const t=await fetch(`${e}/api/resume-fix`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({original_analysis:m,user_email:l.value,payment_id:`pi_${Date.now()}`})});if(console.log(`ğŸ“ˆ PAYMENT: API Response status: ${t.status}`),console.log("ğŸ“„ PAYMENT: Response headers:",Object.fromEntries(t.headers.entries())),!t.ok){const n=await t.text();throw console.error(`âŒ PAYMENT: API Error (${t.status}):`,n),new Error(`Resume improvement failed: ${t.status} - ${n}`)}const a=await t.json();console.log("âœ… PAYMENT: Resume improvement completed successfully"),console.log(`ğŸ“Š PAYMENT: Result keys: ${Object.keys(a)}`),console.log(`ğŸ“„ PAYMENT: Has PDF URL: ${"improved_resume_url"in a}`),a.improved_resume_url&&(console.log(`ğŸ“ PAYMENT: PDF URL type: ${typeof a.improved_resume_url}`),console.log(`ğŸ“ PAYMENT: PDF URL length: ${a.improved_resume_url.length}`)),sessionStorage.setItem("cvRewriteResult",JSON.stringify(a)),console.log("ğŸ’¾ PAYMENT: Stored result in sessionStorage"),console.log("ğŸ’¾ PAYMENT: Stored data preview:",{status:a.status,original_score:a.original_score,new_score:a.new_score,has_pdf_url:!!a.improved_resume_url})}catch(e){throw console.error("CV rewrite failed:",e),e}}function B(e){const t=e.replace(/\s+/g,"").replace(/[^0-9]/gi,""),a=t.match(/\d{4,16}/g),n=a&&a[0]||"",s=[];for(let r=0,g=n.length;r<g;r+=4)s.push(n.substring(r,r+4));s.length?o.value=s.join(" "):o.value=t}function V(e){const t=e.replace(/\s+/g,"").replace(/[^0-9]/gi,"");t.length>=2?i.value=t.substring(0,2)+"/"+t.substring(2,4):i.value=t}function b(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function w(e){const t=e.replace(/\s/g,"");return t.length>=13&&t.length<=19}function N(e){if(!/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(e))return!1;const[a,n]=e.split("/"),s=new Date,r=s.getFullYear()%100,g=s.getMonth()+1,v=parseInt(n),A=parseInt(a);return!(v<r||v===r&&A<g)}function p(e){return e.length>=3&&e.length<=4&&/^\d+$/.test(e)}function O(e){const t=e.target,a=t.value;let n=!0,s="";switch(t.name){case"email":n=b(a),s="Please enter a valid email address";break;case"cardNumber":n=w(a),s="Please enter a valid card number";break;case"expiryDate":n=N(a),s="Please enter a valid expiry date (MM/YY)";break;case"cvv":n=p(a),s="Please enter a valid CVV";break}!n&&a?c(t,s):f(t)}function c(e,t){f(e),e.classList.add("border-red-500");const a=document.createElement("div");a.className="text-red-500 text-sm mt-1",a.textContent=t,a.id=`${e.name}-error`,e.parentNode.appendChild(a)}function f(e){e.classList.remove("border-red-500");const t=e.parentNode.querySelector(`#${e.name}-error`);t&&t.remove()}function P(e){e?(u.classList.add("hidden"),E.classList.remove("hidden"),h.disabled=!0):(u.classList.remove("hidden"),E.classList.add("hidden"),h.disabled=!1)}function y(e){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.remove()},5e3)}document.addEventListener("DOMContentLoaded",Y);
