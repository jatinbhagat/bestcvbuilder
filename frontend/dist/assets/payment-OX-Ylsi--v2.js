import{s as N,D}from"./supabase-DQ_B3N6C-v2.js";const u=document.getElementById("paymentForm"),c=document.getElementById("email"),o=document.getElementById("cardNumber"),i=document.getElementById("expiryDate"),d=document.getElementById("cvv"),I=document.getElementById("terms"),h=document.getElementById("payButton"),E=document.getElementById("paymentLoading"),C=2900,M="usd";let f=null;function S(){console.log("Payment page initialized"),V(),B(),R()}function V(){try{const e=sessionStorage.getItem("upgradeAnalysis")||sessionStorage.getItem("currentAnalysis");e?(f=JSON.parse(e),console.log("Loaded analysis data for payment:",f)):(console.warn("No analysis data found for payment"),y("No analysis data found. Please upload a resume first."))}catch(e){console.error("Error loading analysis data:",e)}}function B(){u&&u.addEventListener("submit",Y),o&&o.addEventListener("input",$),i&&i.addEventListener("input",A),d&&d.addEventListener("input",p)}function R(){[c,o,i,d].forEach(t=>{t&&(t.addEventListener("blur",O),t.addEventListener("input",g))})}async function Y(e){if(e.preventDefault(),console.log("Processing payment..."),!!F()){b(!0);try{const t=await T();await _(t),await k(),window.location.href="./success.html"}catch(t){console.error("Payment failed:",t),y("Payment failed. Please try again.")}finally{b(!1)}}}function F(){let e=!0;return w(c.value)||(l(c,"Please enter a valid email address"),e=!1),P(o.value)||(l(o,"Please enter a valid card number"),e=!1),x(i.value)||(l(i,"Please enter a valid expiry date (MM/YY)"),e=!1),p(d.value)||(l(d,"Please enter a valid CVV"),e=!1),I.checked||(y("Please accept the terms and conditions"),e=!1),e}async function T(){return console.log("Processing payment with Stripe..."),await new Promise(e=>setTimeout(e,2e3)),{id:`pi_${Date.now()}`,amount:C,currency:M,status:"succeeded",method:"card",email:c.value}}async function _(e){var t;try{const n=((t=(await N.auth.getUser()).data.user)==null?void 0:t.id)||"anonymous";await D.savePaymentRecord(n,{amount:e.amount,status:e.status,method:e.method,payment_id:e.id}),console.log("Payment record saved")}catch(a){console.error("Failed to save payment record:",a)}}async function k(){try{console.log("Triggering resume improvement...");const e=await fetch("/api/resume-fix",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({original_analysis:f,user_email:c.value,payment_id:`pi_${Date.now()}`})});if(!e.ok)throw new Error("Resume improvement failed");const t=await e.json();console.log("Resume improvement completed:",t),sessionStorage.setItem("cvRewriteResult",JSON.stringify(t))}catch(e){throw console.error("CV rewrite failed:",e),e}}function $(e){const t=e.replace(/\s+/g,"").replace(/[^0-9]/gi,""),a=t.match(/\d{4,16}/g),n=a&&a[0]||"",r=[];for(let s=0,m=n.length;s<m;s+=4)r.push(n.substring(s,s+4));r.length?o.value=r.join(" "):o.value=t}function A(e){const t=e.replace(/\s+/g,"").replace(/[^0-9]/gi,"");t.length>=2?i.value=t.substring(0,2)+"/"+t.substring(2,4):i.value=t}function w(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function P(e){const t=e.replace(/\s/g,"");return t.length>=13&&t.length<=19}function x(e){if(!/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(e))return!1;const[a,n]=e.split("/"),r=new Date,s=r.getFullYear()%100,m=r.getMonth()+1,v=parseInt(n),L=parseInt(a);return!(v<s||v===s&&L<m)}function p(e){return e.length>=3&&e.length<=4&&/^\d+$/.test(e)}function O(e){const t=e.target,a=t.value;let n=!0,r="";switch(t.name){case"email":n=w(a),r="Please enter a valid email address";break;case"cardNumber":n=P(a),r="Please enter a valid card number";break;case"expiryDate":n=x(a),r="Please enter a valid expiry date (MM/YY)";break;case"cvv":n=p(a),r="Please enter a valid CVV";break}!n&&a?l(t,r):g(t)}function l(e,t){g(e),e.classList.add("border-red-500");const a=document.createElement("div");a.className="text-red-500 text-sm mt-1",a.textContent=t,a.id=`${e.name}-error`,e.parentNode.appendChild(a)}function g(e){e.classList.remove("border-red-500");const t=e.parentNode.querySelector(`#${e.name}-error`);t&&t.remove()}function b(e){e?(u.classList.add("hidden"),E.classList.remove("hidden"),h.disabled=!0):(u.classList.remove("hidden"),E.classList.add("hidden"),h.disabled=!1)}function y(e){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.remove()},5e3)}document.addEventListener("DOMContentLoaded",S);
