import{s as h,D as v}from"./supabase-BWdB_AVO-v2.js";const d=document.getElementById("jobInputForm"),u=document.getElementById("analyzeJobBtn"),m=document.getElementById("buttonText"),l=document.getElementById("loadingText"),c=document.getElementById("formErrors"),E=document.getElementById("errorMessages"),i=document.getElementById("roleTitle"),w=document.getElementById("companyName"),r=document.getElementById("jobDescription"),x=document.getElementById("salaryMin"),_=document.getElementById("salaryMax"),I=document.getElementById("additionalNotes"),j=(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1","/api");let s=null;document.addEventListener("DOMContentLoaded",function(){console.log("Job input page initialized"),J(),S(),L()});async function J(){try{const{data:{user:e},error:t}=await h.auth.getUser();if(t){console.error("Error getting user:",t),s="anonymous_"+Date.now();return}e?(s=e.id,console.log("User authenticated:",e.email)):(s="anonymous_"+Date.now(),console.log("Anonymous user session"))}catch(e){console.error("Error initializing user:",e),s="anonymous_"+Date.now()}}function S(){d&&d.addEventListener("submit",N),[i,r].forEach(t=>{t&&(t.addEventListener("blur",B),t.addEventListener("input",g))}),r&&r.addEventListener("input",C)}function L(){if(r){const e=r.parentElement,t=document.createElement("div");t.id="charCounter",t.className="text-xs text-gray-500 mt-1 text-right",t.textContent="0 characters",e.appendChild(t)}}async function N(e){if(e.preventDefault(),console.log("Job input form submitted"),!!A()){y(!0),k();try{const t=T();sessionStorage.setItem("jobInputData",JSON.stringify(t));const o=await D(t);await F(t,o),sessionStorage.setItem("jobAnalysisResult",JSON.stringify(o)),z(),setTimeout(()=>{window.location.href="./optimization-results.html"},2e3)}catch(t){console.error("Error processing job input:",t),p([t.message||"Failed to analyze job requirements. Please try again."])}finally{y(!1)}}}function T(){const e=Array.from(document.querySelectorAll('input[name="focusAreas"]:checked')).map(t=>t.value);return{roleTitle:i.value.trim(),companyName:w.value.trim(),jobDescription:r.value.trim(),salaryRange:{min:x.value.trim(),max:_.value.trim()},focusAreas:e,additionalNotes:I.value.trim(),timestamp:new Date().toISOString(),userId:s}}function A(){const e=[];return i.value.trim()||(e.push("Job title is required"),a(i)),r.value.trim()?r.value.trim().length<50&&(e.push("Job description should be at least 50 characters long"),a(r)):(e.push("Job description is required"),a(r)),e.length>0?(p(e),!1):!0}function B(e){const t=e.target;g(t),t===i&&!t.value.trim()&&a(t,"Job title is required"),t===r&&(t.value.trim()?t.value.trim().length<50&&a(t,"Job description should be at least 50 characters"):a(t,"Job description is required"))}function a(e,t=null){if(e.classList.add("border-red-500"),e.classList.remove("border-gray-200","border-blue-500"),t){const o=e.parentElement.querySelector(".field-error");o&&o.remove();const n=document.createElement("div");n.className="field-error text-red-500 text-xs mt-1",n.textContent=t,e.parentElement.appendChild(n)}}function g(e){typeof e=="object"&&e.target&&(e=e.target),e.classList.remove("border-red-500"),e.classList.add("border-gray-200");const t=e.parentElement.querySelector(".field-error");t&&t.remove()}function C(){const e=document.getElementById("charCounter");if(e){const t=r.value.length;e.textContent=`${t} characters`,t<50?(e.classList.add("text-red-500"),e.classList.remove("text-gray-500")):(e.classList.add("text-gray-500"),e.classList.remove("text-red-500"))}}async function D(e){console.log("Calling job analyzer API...");let t;try{t=await fetch(`${j}/job-analyzer`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_description:e.jobDescription,role_title:e.roleTitle,company_name:e.companyName,user_expectations:{salary_range:e.salaryRange,focus_areas:e.focusAreas,additional_notes:e.additionalNotes}})})}catch(n){throw console.error("Network error:",n),new Error("Unable to connect to server - please check your internet connection and try again")}if(!t.ok){let n;try{n=(await t.json()).error||`HTTP ${t.status}: Failed to analyze job requirements`}catch{const f=await t.text().catch(()=>"Unknown error");console.error("Non-JSON error response:",f),n=`HTTP ${t.status}: Server error - please try again`}throw new Error(n)}let o;try{o=await t.json(),console.log("Job analysis completed:",o)}catch(n){throw console.error("Failed to parse JSON response:",n),new Error("Invalid response from server - please try again")}return o}async function F(e,t){try{console.log("Saving job analysis to database...");const o={user_id:s,role_title:e.roleTitle,company_name:e.companyName,job_description:e.jobDescription,extracted_requirements:t.extracted_requirements||{},user_expectations:{salary_range:e.salaryRange,focus_areas:e.focusAreas,additional_notes:e.additionalNotes},analysis_score:t.analysis_score||0,matching_keywords:t.matching_keywords||[],created_at:new Date().toISOString()};s.startsWith("anonymous_")?(sessionStorage.setItem("jobAnalysisData",JSON.stringify(o)),console.log("Job analysis stored in session for anonymous user")):(await v.saveJobAnalysis(s,o),console.log("Job analysis saved to database"))}catch(o){console.error("Error saving job analysis:",o)}}function y(e){e?(u.disabled=!0,m.style.display="none",l.style.display="flex",l.classList.remove("hidden")):(u.disabled=!1,m.style.display="inline",l.style.display="none",l.classList.add("hidden"))}function p(e){E.innerHTML=e.map(t=>`<div>• ${t}</div>`).join(""),c.classList.remove("hidden"),c.scrollIntoView({behavior:"smooth",block:"center"})}function k(){c.classList.add("hidden")}function z(){const e=document.createElement("div");e.className="fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center",e.innerHTML=`
        <span class="mr-2">✅</span>
        <div>
            <div class="font-bold">Job Analysis Complete!</div>
            <div class="text-sm opacity-90">Preparing your optimized resume...</div>
        </div>
    `,document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)}function q(e,t={}){try{typeof gtag<"u"&&gtag("event",e,t),console.log("Event tracked:",e,t)}catch(o){console.error("Error tracking event:",o)}}q("job_input_page_view",{page_title:"Job Input",page_location:window.location.href});
